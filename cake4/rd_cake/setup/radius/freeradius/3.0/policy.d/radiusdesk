RADIUSdesk.authorize {

	#hostapd Private PSK
	RADIUSdesk_rewrite_mac_username
	if((&request:WLAN-AKM-Suite)&&(&request:WLAN-AKM-Suite==1027074)){
        pl_ppsk          
    }

    #We created a less strict "filter_username" since the default one from FreeRADIUS are very strict in terms of the Realm
    #Which it assumes is part of the username
	RADIUSdesk_filter_username

    #RADIUSdesk -> Used to normalise the callingstation id to format aa-bb-cc-dd-ee.. (lowercase with dash)
	RADIUSdesk_rewrite_calling_station_id
	
	if((&control:RADIUSdesk-Virtual-Server)&&(&control:RADIUSdesk-Virtual-Server == 'radiusdesk-plain')){	
	     #Check if this client is allowed here
        RADIUSdesk_find_dynamic_client        
        #Check if there are limits to this client in terms of data usage
        RADIUSdesk_nas_data_counter	
	}
	
	#RADIUSdesk -> We will not do all the RADIUSdesk things on EAP outer tunnel 
    if (!EAP-Message) {
        #RADIUSdesk add-on
        RADIUSdesk_main
    }
    else{
        eap {
            ok = return
        }
    }
    
    #RADIUSdesk -> expiration and logintime will set a reply attribute for Session-Timeout. 
    #We may however have to override it if
    #the **time based counter** or the Voucher's **time left** is **smaller** than the Session-Timeout
    RADIUSdesk_session_timeout
    RADIUSdesk_logintime
    RADIUSdesk_adv

    #RADIUSdesk -> MAC Authentication
    #If this was a valid device which passed all the tests AND auth type is not yet set; allow it.
    if((&control:Rd-User-Type =='device')&&(!&control:Auth-Type)){
        update control{
            Auth-Type := "Accept"
        }
    }

    if((&control:Rd-User-Type =='voucher-device')&&(!&control:Auth-Type)){
        update control{
            Auth-Type := "Accept"
        }
    }	
}


RADIUSdesk.preacct {
    if((&control:RADIUSdesk-Virtual-Server)&&(&control:RADIUSdesk-Virtual-Server == 'radiusdesk-plain')){	
        RADIUSdesk_acct_dynamic_client_check
        if(&control:Rd-Dynamic-Client == 1){
            #RADIUSdesk -> Add realm etc before accounting
            RADIUSdesk_preacct
        }        
    }
    update request {
        Event-Timestamp := "%l"
    }
}


RADIUSdesk.accounting {
    RADIUSdesk_acct
    RADIUSdesk_last_contact
}

RADIUSdesk.post-auth {
	RADIUSdesk_last_accept
	RADIUSdesk_post_auth
    RADIUSdesk_auto_devices_check
}

#____ RADIUSdesk policies __________

RADIUSdesk_filter_username {
	if (&User-Name) {	
		if (&User-Name =~ / /) {
			update request {
				&Module-Failure-Message += 'Rejected: User-Name contains whitespace'
			}
			reject
		}
	}
}

RADIUSdesk_rewrite_mac_username {
    # This is for hostapd Private PSK
    # User-Name = "0cc6fd7b8b11"
    # User-Password = "0cc6fd7b8b11"
    # NAS-Identifier = "dev_apeap_34"
    # Called-Station-Id = "00-25-82-00-92-31:Dev"
    # NAS-Port-Type = Wireless-802.11
    # Calling-Station-Id = "0C-C6-FD-7B-8B-11"
    # Connect-Info = "CONNECT 11Mbps 802.11b"
    # Message-Authenticator = 0xc16fbf280533bd3a1eaa604270f8d98e

    if((&request:User-Name)&&(&request:User-Password)&&(&request:Calling-Station-Id)){
        if(&User-Name =~ /([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})/i){
            if(&request:User-Name == &request:User-Password){
                if(&request:Calling-Station-Id == "%{toupper:%{1}-%{2}-%{3}-%{4}-%{5}-%{6}}"){
                    update request {
                        User-Name := "%{toupper:%{1}-%{2}-%{3}-%{4}-%{5}-%{6}}"
                        User-Password := "%{toupper:%{1}-%{2}-%{3}-%{4}-%{5}-%{6}}"
                	}
                	update control {
                	    Rd-Ppsk-Flag := 1
                	}
                }           
            }    
        }
    }
}

RADIUSdesk_rewrite_mac_username_acct {
    # This is for hostapd Private PSK
    # Acct-Status-Type = Start
    # Acct-Authentic = Local
    # User-Name = "0cc6fd7b8b11"
    # NAS-Identifier = "dev_apeap_34"
    # Called-Station-Id = "00-25-82-00-92-31:Dev"
    # NAS-Port-Type = Wireless-802.11
    # Service-Type = Framed-User
    # NAS-Port = 1
    # Calling-Station-Id = "0C-C6-FD-7B-8B-11"
    # Connect-Info = "CONNECT 54Mbps 802.11g"
    # Acct-Session-Id = "6CC7A8C9FB9AF31C"
    # WLAN-Pairwise-Cipher = 1027076
    # WLAN-Group-Cipher = 1027076
    # WLAN-AKM-Suite = 1027074
    # Event-Timestamp = "Feb 28 2023 21:53:08 UTC"
   
    if((&request:User-Name)&&(&request:Calling-Station-Id)){
        if(&User-Name =~ /([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})/i){
            if(&request:Calling-Station-Id == "%{toupper:%{1}-%{2}-%{3}-%{4}-%{5}-%{6}}"){
                update request {
                    User-Name := "%{toupper:%{1}-%{2}-%{3}-%{4}-%{5}-%{6}}"
            	}
            	update control {
                    Rd-Ppsk-Flag := 1
                }
            }         
        }
    }
}

RADIUSdesk_ppsk_defaults {

    if(&control:Rd-Ppsk-Flag){
        if(&control:Rd-Ppsk-Flag == 1){       
            if(!&reply:Tunnel-Password){
                update control {
                    Rd-Ppsk-Vlan := "%{sql:SELECT IFNULL((SELECT dynamic_client_settings.value FROM dynamic_client_settings LEFT JOIN dynamic_clients ON dynamic_client_settings.dynamic_client_id=dynamic_clients.id WHERE dynamic_clients.nasidentifier ='%{request:NAS-Identifier}' AND dynamic_clients.type = 'private_psk' AND dynamic_client_settings.name = 'ppsk_default_vlan'),0)}"
                    #This sets the default key to '12345678' if it does not find a default key
                    Rd-Ppsk-Key := "%{sql:SELECT IFNULL((SELECT dynamic_client_settings.value FROM dynamic_client_settings LEFT JOIN dynamic_clients ON dynamic_client_settings.dynamic_client_id=dynamic_clients.id WHERE dynamic_clients.nasidentifier ='%{request:NAS-Identifier}' AND dynamic_clients.type = 'private_psk' AND dynamic_client_settings.name = 'ppsk_default_key'),'12345678')}"
                    #Check if we need to record out MAC Address
                    Rd-Ppsk-Mac := "%{sql:SELECT IFNULL((SELECT dynamic_client_settings.value FROM dynamic_client_settings LEFT JOIN dynamic_clients ON dynamic_client_settings.dynamic_client_id=dynamic_clients.id WHERE dynamic_clients.nasidentifier ='%{request:NAS-Identifier}' AND dynamic_clients.type = 'private_psk' AND dynamic_client_settings.name = 'ppsk_record_mac'),0)}"
                }                    
                update reply {
                    Tunnel-Password := "%{control:Rd-Ppsk-Key}"
                }                    
                if(&control:Rd-Ppsk-Vlan != 0){
                    update reply {                
                        Tunnel-Type := "VLAN"
                        Tunnel-Medium-Type := "IEEE-802"
                        Tunnel-Private-Group-ID := "%{control:Rd-Ppsk-Vlan}"
                    }
                }
                #See if we need to record the MAC
                if(&control:Rd-Ppsk-Mac == 1){
                    "%{sql:INSERT INTO client_macs (mac,created,modified) VALUES('%{toupper:%{request:Calling-Station-Id}}',NOW(),NOW()) ON DUPLICATE KEY UPDATE modified=NOW()}"
                    update control {
                        Rd-Ppsk-Mac-Id := "%{sql:SELECT client_macs.id FROM client_macs WHERE client_macs.mac ='%{toupper:%{request:Calling-Station-Id}}'}"
                        Rd-Ppsk-Dyn-Id  := "%{sql:SELECT dynamic_clients.id FROM dynamic_clients WHERE nasidentifier ='%{request:NAS-Identifier}'}"
                    }
                    "%{sql:INSERT INTO dynamic_client_macs (dynamic_client_id,client_mac_id,created,modified) VALUES('%{control:Rd-Ppsk-Dyn-Id}','%{control:Rd-Ppsk-Mac-Id}',NOW(),NOW()) ON DUPLICATE KEY UPDATE modified=NOW()}"
                }
                                
                update control{
                    Auth-Type := "Accept"
                }
                #return updated
                updated
            }
        }    
    }
    ok
}

RADIUSdesk_acct_dynamic_client_check {
    update control {
        #Set it to zero which means we don't know this client
        Rd-Dynamic-Client := 0
        #Set Rd-Unknown-Added and not added yet
        Rd-Unknown-Added := 0
        #Set client updated to 0
        Rd-Client-Updated := 0
    }

    if(&request:NAS-Identifier){

        #Check wether the client is there and active
        update control {
            #If we do not find an entry we return 2
            Rd-Client-Active := "%{sql:SELECT IFNULL((SELECT dynamic_clients.active FROM dynamic_clients WHERE nasidentifier='%{request:NAS-Identifier}'),2)}"
        }

        if((&control:Rd-Client-Active == 0)||(&control:Rd-Client-Active == 1)){
            #Update the 'most recent' ip and timestamp
            "%{sql:UPDATE dynamic_clients SET \
                last_contact_ip='%{request:Packet-Src-IP-Address}', \
                last_contact=now() \
                WHERE nasidentifier='%{request:NAS-Identifier}' \
            }"

            update control {
                Rd-Client-Updated := 1
            }

            if(&control:Rd-Client-Active == 1){
                update control {
                    Rd-Dynamic-Client := 1
                }
            }
        }
        
        #We did not find it; record it in unknown
        if(&control:Rd-Client-Active == 2){
            #Jun 2024 - We incorporate a convenient Perl script to automatically add dynamic clients (The script has a flag to enable it)
            pl_auto_add_dynamic_client
            if(updated){
                update control {
                    Rd-Dynamic-Client := 1
                    Rd-Client-Updated := 1
                    Rd-Client-Active  := 1
                }
            }else{     
                "%{sql:INSERT INTO unknown_dynamic_clients SET nasidentifier='%{request:NAS-Identifier}', \
                    last_contact_ip='%{request:Packet-Src-IP-Address}', \
                    last_contact=now(), \
                    calledstationid='%{request:Called-Station-Id}' \
                    on duplicate key update last_contact=now(),last_contact_ip='%{request:Packet-Src-IP-Address}' \
                }"
                update control {
                    Rd-Unknown-Added := 1
                }
            }
        }
        
    }

    #Called-Station-Id - We only enter here if it was not set in the first place
    if((&control:Rd-Client-Active == 2)&&(&request:Called-Station-Id)){

        #Check whether the client is there and active
        update control {
            #If we do not find an entry we return 2
            Rd-Client-Active := "%{sql:SELECT IFNULL((SELECT dynamic_clients.active FROM dynamic_clients WHERE calledstationid='%{request:Called-Station-Id}'),2)}"
        }

        if((&control:Rd-Client-Active == 0)||(&control:Rd-Client-Active == 1)){

            #Only if it has not been updated
            if(&control:Rd-Client-Updated == 0){
                #Update the 'most recent' ip and timestamp
                "%{sql:UPDATE dynamic_clients SET \
                    last_contact_ip='%{request:Packet-Src-IP-Address}', \
                    last_contact=now() \
                    WHERE calledstationid='%{request:Called-Station-Id}' \
                }"
            }

            if(&control:Rd-Client-Active == 1){
                update control {
                    Rd-Dynamic-Client := 1
                }
            }
        }

        if(&control:Rd-Client-Active == 2){
            #Update the unknown_dynamic_clients table only if it was not updated before
            if(&control:Rd-Unknown-Added == 0){
                "%{sql:INSERT INTO unknown_dynamic_clients SET nasidentifier='%{request:NAS-Identifier}', \
                    last_contact_ip='%{request:Packet-Src-IP-Address}', \
                    last_contact=now(), \
                    calledstationid='%{request:Called-Station-Id}' \
                    on duplicate key update last_contact=now(),last_contact_ip='%{request:Packet-Src-IP-Address}' \
                }"
                update control {
                    Rd-Unknown-Added := 1
                }
            }
        }
    }
    ok
}


RADIUSdesk_find_dynamic_client {

    update control {
        #Set it to zero which means we don't know this client
        Rd-Dynamic-Client := 0
        #Set Rd-Unknown-Added and not added yet
        Rd-Unknown-Added := 0
        #Set client updated to 0
        Rd-Client-Updated := 0
    }

    #NAS-Identifier
    if(&request:NAS-Identifier){

        #Check wether the client is there and active
        update control {
            #If we do not find an entry we return 2
            Rd-Client-Active := "%{sql:SELECT IFNULL((SELECT dynamic_clients.active FROM dynamic_clients WHERE nasidentifier='%{request:NAS-Identifier}'),2)}"
        }

        if((&control:Rd-Client-Active == 0)||(&control:Rd-Client-Active == 1)){

            #Update the 'most recent' ip and timestamp
            "%{sql:UPDATE dynamic_clients SET \
                last_contact_ip='%{request:Packet-Src-IP-Address}', \
                last_contact=now() \
                WHERE nasidentifier='%{request:NAS-Identifier}' \
            }"

            update control {
                Rd-Client-Updated := 1
            }

            if(&control:Rd-Client-Active == 1){
                update control {
                    Rd-Dynamic-Client := 1
                }
            }
            else {
                update reply {                
                    Reply-Message := "NAS-Identifier %{request:NAS-Identifier} is disabled"
                }
                reject
            }
        }

        #We did not find it; record it in unknown
        if(&control:Rd-Client-Active == 2){
            #Jun 2024 - We incorporate a convenient Perl script to automatically add dynamic clients (The script has a flag to enable it)
            pl_auto_add_dynamic_client
            if(updated){
                update control {
                    Rd-Dynamic-Client := 1
                    Rd-Client-Updated := 1
                    Rd-Client-Active  := 1
                }
            }else{     
                "%{sql:INSERT INTO unknown_dynamic_clients SET nasidentifier='%{request:NAS-Identifier}', \
                    last_contact_ip='%{request:Packet-Src-IP-Address}', \
                    last_contact=now(), \
                    calledstationid='%{request:Called-Station-Id}' \
                    on duplicate key update last_contact=now(),last_contact_ip='%{request:Packet-Src-IP-Address}' \
                }"
                update control {
                    Rd-Unknown-Added := 1
                }
            }
        }
    }
    
    #Called-Station-Id - We only enter here if it was not set in the first place
    if((&control:Rd-Client-Active == 2)&&(&request:Called-Station-Id)){

         #Check whether the client is there and active
        update control {
            #If we do not find an entry we return 2
            Rd-Client-Active := "%{sql:SELECT IFNULL((SELECT dynamic_clients.active FROM dynamic_clients WHERE calledstationid='%{request:Called-Station-Id}'),2)}"
        }

        if((&control:Rd-Client-Active == 0)||(&control:Rd-Client-Active == 1)){

            #Only if it has not been updated
            if(&control:Rd-Client-Updated == 0){
                #Update the 'most recent' ip and timestamp
                "%{sql:UPDATE dynamic_clients SET \
                    last_contact_ip='%{request:Packet-Src-IP-Address}', \
                    last_contact=now() \
                    WHERE calledstationid='%{request:Called-Station-Id}' \
                }"
            }

            if(&control:Rd-Client-Active == 1){
                update control {
                    Rd-Dynamic-Client := 1
                }
            }
            else {
                update reply {                
                    Reply-Message := "Called-Station-Id %{request:Called-Station-Id} is disabled"
                }
                reject
            }
        }

        if(&control:Rd-Client-Active == 2){
            #Update the unknown_dynamic_clients table only if it was not updated before
            if(&control:Rd-Unknown-Added == 0){
                "%{sql:INSERT INTO unknown_dynamic_clients SET nasidentifier='%{request:NAS-Identifier}', \
                    last_contact_ip='%{request:Packet-Src-IP-Address}', \
                    last_contact=now(), \
                    calledstationid='%{request:Called-Station-Id}' \
                    on duplicate key update last_contact=now(),last_contact_ip='%{request:Packet-Src-IP-Address}' \
                }"
            }
            update control {
                Rd-Unknown-Added := 1
            }
        }
    }

    #If it was not identified nor disabled we reject it
    if(&control:Rd-Dynamic-Client == 0){
        update reply {
            Reply-Message := "RADIUS client not allowed. Contact server administrator"
        }
        reject
    }
}

    RADIUSdesk_rewrite_calling_station_id {
        if(&request:Calling-Station-Id){
       		if(&request:Calling-Station-Id =~ /([0-9a-f]{2})[-:]?([0-9a-f]{2})[-:]?([0-9a-f]{2})[-:]?([0-9a-f]{2})[-:]?([0-9a-f]{2})[-:]?([0-9a-f]{2})/i){
                	update request {
                        	Calling-Station-Id := "%{1}-%{2}-%{3}-%{4}-%{5}-%{6}"
                	}
        	}
        	else {
                	noop
        	}
        }
        else {
            noop
        }
	}


	RADIUSdesk_rewrite_called_station_id {
        if(&request:Called-Station-Id =~ /^([0-9a-f]{2})[-:]?([0-9a-f]{2})[-:.]?([0-9a-f]{2})[-:]?([0-9a-f]{2})[-:.]?([0-9a-f]{2})[-:]?([0-9a-f]{2})[-:]?([-a-z0-9_. ]*)?/i){

				if("%{7}"){
                	update control {
                        Rd-Ssid-Value := "%{7}"
                	}
					updated
				}
				else {
					noop
				} 
        }
        else {
                noop
        }
	}


RADIUSdesk_device_check {

    update control {
        Rd-Mac-Tmp-Username := "%{request:User-Name}"
    }

    update request {
        User-Name := "%{request:Calling-Station-Id}"
    }
    RADIUSdesk_user_check

    update request {
        User-Name := "%{control:Rd-Mac-Tmp-Username}"
   }
}

RADIUSdesk_device_owner_check {

    update control {
		    Rd-Mac-Tmp-Username := "%{request:User-Name}"
    }
    update request {
        User-Name := "%{control:Rd-Tmp-Owner}"
    }
    RADIUSdesk_user_check

    update request {
        User-Name := "%{control:Rd-Mac-Tmp-Username}"
    }
    RADIUSdesk_user_check
}

#--------------------------
#--New addition Sept 2018--
#--------------------------
RADIUSdesk_nas_data_counter {

    update control {
        #Set it to zero which means it is not active
        Rd-Data-Limit-Active := 0
    }

    #NAS-Identifier
    if(&request:NAS-Identifier){
        update control {
            Rd-Data-Limit-Active := "%{sql:SELECT IFNULL((SELECT dynamic_clients.data_limit_active FROM dynamic_clients WHERE nasidentifier='%{request:NAS-Identifier}'),0)}"  
        }
    
        if(&control:Rd-Data-Limit-Active == 1){
            update control {
            
                Rd-Data-Limit-Amount := "%{sql:SELECT IFNULL((SELECT dynamic_clients.data_limit_amount FROM dynamic_clients WHERE nasidentifier='%{request:NAS-Identifier}'),1)}"
                Rd-Data-Limit-Unit := "%{sql:SELECT IFNULL((SELECT dynamic_clients.data_limit_unit FROM dynamic_clients WHERE nasidentifier='%{request:NAS-Identifier}'),'mb')}"
                Rd-Data-Limit-Reset-On := "%{sql:SELECT IFNULL((SELECT dynamic_clients.data_limit_reset_on FROM dynamic_clients WHERE nasidentifier='%{request:NAS-Identifier}'),1)}"
                Rd-Data-Limit-Reset-Hour := "%{sql:SELECT IFNULL((SELECT dynamic_clients.data_limit_reset_hour FROM dynamic_clients WHERE nasidentifier='%{request:NAS-Identifier}'),0)}"
                 Rd-Data-Limit-Reset-Min := "%{sql:SELECT IFNULL((SELECT dynamic_clients.data_limit_reset_minute FROM dynamic_clients WHERE nasidentifier='%{request:NAS-Identifier}'),0)}"
            }
            
            #Use Perl to determine the Rd-Data-Start-Time based on the value of Rd-Data-Limit-Reset-On
            pl_client_start_time
            
            update control {
                Rd-Data-Used := "%{sql:SELECT IFNULL(SUM(acctinputoctets - GREATEST((%{control:Rd-Data-Start-Time} - UNIX_TIMESTAMP(acctstarttime)), 0))\
                        + SUM(acctoutputoctets -GREATEST((%{control:Rd-Data-Start-Time} - UNIX_TIMESTAMP(acctstarttime)), 0)),0)\
                        FROM radacct_history WHERE nasidentifier='%{request:NAS-Identifier}' \
                        AND UNIX_TIMESTAMP(acctstarttime) + acctsessiontime > '%{control:Rd-Data-Start-Time}'}"
            }
            pl_client_check_usage      
         }
    }
}
#------------------------------
#--END New addition Sept 2018--
#------------------------------

RADIUSdesk_data_counter {

    if((&control:Rd-Total-Data)&&(&control:Rd-Reset-Type-Data)&&(&control:Rd-Cap-Type-Data == 'hard')){
        pl_reset_time_for_data
        if(updated){ # Reset Time was updated,
            # we can now use it in a query
            if(&control:Rd-Tmp-Avail-Data){ #This indicates it it a device!
                update control {
                    Rd-Used-Data := "{sql:SELECT IFNULL(SUM(acctinputoctets + acctoutputoctets), 0) FROM user_stats WHERE callingstationid = '%{request:User-Name}' AND UNIX_TIMESTAMP(timestamp) >= %{control:Rd-Start-Time}}"
                }
            }
            else{ 
                #Here we need to see if the counter is to be applied on the device level and there is a device present in the request
                if((&control:Rd-Mac-Counter-Data)&&(&request:Calling-Station-Id)){
                    update control {
                        Rd-Used-Data := "%{sql:SELECT IFNULL(SUM(acctinputoctets + acctoutputoctets), 0) FROM user_stats WHERE username = '%{request:User-Name}' AND callingstationid = '%{request:Calling-Station-Id}' AND UNIX_TIMESTAMP(created) >= %{control:Rd-Start-Time}}"
                    }
                }
                else{
                    update control {
                        Rd-Used-Data := "%{sql:SELECT IFNULL(SUM(acctinputoctets + acctoutputoctets), 0) FROM user_stats WHERE username = '%{request:User-Name}' AND UNIX_TIMESTAMP(created) >= %{control:Rd-Start-Time}}"
                    }
                }
            }
        }
        else{
            #Asumes reset type = never
            #Get the total usage of the user
            if(&control:Rd-Tmp-Avail-Data){ #This indicates it it a device!
                update control {
                    Rd-Used-Data := "%{sql:SELECT IFNULL(SUM(acctinputoctets)+SUM(acctoutputoctets),0) FROM user_stats WHERE callingstationid='%{request:User-Name}'}"
                }
            }
            else{
                if((&control:Rd-Mac-Counter-Data)&&(&request:Calling-Station-Id)){
                    update control {
                        Rd-Used-Data := "%{sql:SELECT IFNULL(SUM(acctinputoctets)+SUM(acctoutputoctets),0) FROM user_stats WHERE username='%{request:User-Name}' AND callingstationid='%{request:Calling-Station-Id}'}"
                    }
                }
                else{
                    update control {
                        Rd-Used-Data := "%{sql:SELECT IFNULL(SUM(acctinputoctets)+SUM(acctoutputoctets),0) FROM user_stats WHERE username='%{request:User-Name}'}"
                    }
                }
            }
        }

        #Now we know how much they are allowed to use and the usage.
        pl_check_usage_data
    }
}


RADIUSdesk_time_counter {

    if((&control:Rd-Total-Time)&&(&control:Rd-Reset-Type-Time)&&(&control:Rd-Cap-Type-Time == 'hard')){
        pl_reset_time_for_time
        if(updated){ # Reset Time was updated,
            # we can now use it in a query
            if(&control:Rd-Tmp-Avail-Time){ #This indicates it it a device!
                update control {
					Rd-Used-Time := "%{sql:SELECT IFNULL(SUM(TIMESTAMPDIFF(SECOND, created, timestamp)), 0) FROM user_stats WHERE callingstationid = '%{request:User-Name}' AND UNIX_TIMESTAMP(created) >= %{control:Rd-Start-Time}}"
                }
            }
            else{
                #Here we need to see if the counter is to be applied on the device level and there is a device present in the request
                if((&control:Rd-Mac-Counter-Time)&&(&request:Calling-Station-Id)){
                    update control {
                        Rd-Used-Time := "%{sql:SELECT IFNULL(SUM(TIMESTAMPDIFF(SECOND, created, timestamp)), 0) FROM user_stats WHERE username = '%{request:User-Name}' AND callingstationid = '%{request:Calling-Station-Id}' AND UNIX_TIMESTAMP(created) >= %{control:Rd-Start-Time}}"
                    }
                }
                else{
                    update control {
                        Rd-Used-Time := "%{sql:SELECT IFNULL(SUM(TIMESTAMPDIFF(SECOND, created, timestamp)), 0) FROM user_stats WHERE username = '%{request:User-Name}' AND UNIX_TIMESTAMP(created) >= %{control:Rd-Start-Time}}"
                    }
                }
            }
        }
        else{
            #Asumes reset type = never
            #Get the total usage of the user
            if(&control:Rd-Tmp-Avail-Time){ #This indicates it it a device!
                update control {
                    Rd-Used-Time := "{sql:SELECT IFNULL(SUM(TIMESTAMPDIFF(SECOND, created, timestamp)), 0) FROM user_stats WHERE callingstationid='%{request:User-Name}'}"
                }
            }
            else{
               if((&control:Rd-Mac-Counter-Time)&&(&request:Calling-Station-Id)){
                    update control {
                        Rd-Used-Time := "{sql:SELECT IFNULL(SUM(TIMESTAMPDIFF(SECOND, created, timestamp)), 0) FROM user_stats WHERE username='%{request:User-Name}' AND callingstationid='%{request:Calling-Station-Id}'}"
                    }
                }
                else{
                    update control {
                        Rd-Used-Time := "{sql:SELECT IFNULL(SUM(TIMESTAMPDIFF(SECOND, created, timestamp)), 0) FROM user_stats WHERE username='%{request:User-Name}'}"
                    }
                }
            }
        }

        #Now we know how much they are allowed to use and the usage.
        pl_check_usage_time
    }
}

RADIUSdesk_voucher_check {
    if(&control:Rd-Voucher){

        #Check if the Rd-Voucher is in the correct format
        if(&control:Rd-Voucher =~ /([0-9]{1,3})[-]?([0-9]{2})[-]?([0-9]{2})[-]?([0-9]{2})/i){

                #Get the amount of time available
            	update control {
                    	Rd-Voucher-Time-Available := "%{expr: (%{1} * 86400)+(%{2} * 3600) + (%{3}* 60) +(%{4})}"
            	}

                #Check if the voucher connected before

                if("%{sql:SELECT count(username) FROM radacct_history WHERE radacct_history.username='%{request:User-Name}'}" > 0){

                    update control {
                        #select (UNIX_TIMESTAMP(now()) - UNIX_TIMESTAMP(acctstarttime)) as time_since_login from radacct_history where username='000001' order by acctstarttime ASC LIMIT 1;  
                        Rd-Voucher-Time-Expired := "%{sql:SELECT UNIX_TIMESTAMP(now()) - UNIX_TIMESTAMP(acctstarttime) FROM radacct_history WHERE username='%{request:User-Name}' ORDER by acctstarttime ASC LIMIT 1}"
                    }

                    #Check if there is still time available 
                    if(&control:Rd-Voucher-Time-Expired <= &control:Rd-Voucher-Time-Available){
                        update control {
                            Rd-Voucher-Timeout := "%{expr: %{control:Rd-Voucher-Time-Available} - %{control:Rd-Voucher-Time-Expired}}"
                        }
                    }
                    else{
                        update reply {
                            Reply-Message := "The time for voucher %{request:User-Name} is depleted"
                        }
                        reject
                    }
                }
                else{
                    update control {
                        Rd-Voucher-Timeout := "%{control:Rd-Voucher-Time-Available}"
                    }
                }
    	}
    }
}

RADIUSdesk_realm_nas_check {

    #___This check will be done in two steps ___
    # 1.) If there are no entries of the nas device's id in the na_realms table; any-one can connect and we can pass the request
    # 2.) If however there are entries; we need to check if they contain the realm the user belongs to
    #___________________________________________

    #Only if the request actually contains a value for NAS-Identifier
    if(&request:NAS-Identifier){
        #Check if some realms are associated with this NAS
        if("%{sql:SELECT COUNT(na_realms.id) AS count FROM nas LEFT JOIN na_realms ON nas.id=na_realms.na_id WHERE nas.nasidentifier='%{request:NAS-Identifier}'}" > 0){
            #Only if Rd-Realm is defined; Check if this realm is one of the associated ones. If NOT; reject the request
            if(&control:Rd-Realm){ 
                if("%{sql:SELECT COUNT(nas.nasname) AS count FROM nas LEFT JOIN na_realms ON nas.id=na_realms.na_id LEFT JOIN realms ON realms.id=na_realms.realm_id WHERE nas.nasidentifier='%{request:NAS-Identifier}' AND realms.name='%{control:Rd-Realm}'}" == 0){
                    update reply {
                        Reply-Message := "User %{request:User-Name} belongs to realm %{control:Rd-Realm} which cannot connect to %{request:NAS-Identifier}"
                    }
                    reject
                }
            }
        }
    }    
    
    #Only if the request actually contains a value for NAS-IP-Address
    if(&request:NAS-IP-Address){
        #Check if some realms are associated with this NAS
        if("%{sql:SELECT COUNT(na_realms.id) AS count FROM nas LEFT JOIN na_realms ON nas.id=na_realms.na_id WHERE nas.nasname='%{request:NAS-IP-Address}'}" > 0){
            #Only if Rd-Realm is defined; Check if this realm is one of the associated ones. If NOT; reject the request
            if(&control:Rd-Realm){ 
                if("%{sql:SELECT COUNT(nas.nasname) AS count FROM nas LEFT JOIN na_realms ON nas.id=na_realms.na_id LEFT JOIN realms ON realms.id=na_realms.realm_id WHERE nas.nasname='%{request:NAS-IP-Address}' AND realms.name='%{control:Rd-Realm}'}" == 0){
                    update reply {
                        Reply-Message := "User %{request:User-Name} belongs to realm %{control:Rd-Realm} which cannot connect to %{request:NAS-IP-Address}"
                    }
                    reject
                }
            }
        }
    }    
}


RADIUSdesk_realm_dynamic_client_check {

    #___This check will be done in two steps ___
    # 1.) If there are no entries of the Dynamic Client's id in the dynamic_client_realms table; any-one can connect and we can pass the request
    # 2.) If however there are entries; we need to check if they contain the realm the user belongs to
    #___________________________________________

    #Only if the request actually contains a value for NAS-Identifier
    if(&request:NAS-Identifier){
        #Check if some realms are associated with this NAS
        if("%{sql:SELECT COUNT(dynamic_client_realms.id) AS count FROM dynamic_clients LEFT JOIN dynamic_client_realms ON dynamic_clients.id=dynamic_client_realms.dynamic_client_id WHERE dynamic_clients.nasidentifier='%{request:NAS-Identifier}'}" > 0){
            #Only if Rd-Realm is defined; Check if this realm is one of the associated ones. If NOT; reject the request
            if(&control:Rd-Realm){ 
                if("%{sql:SELECT COUNT(dynamic_clients.name) AS count FROM dynamic_clients LEFT JOIN dynamic_client_realms ON dynamic_clients.id=dynamic_client_realms.dynamic_client_id LEFT JOIN realms ON realms.id=dynamic_client_realms.realm_id WHERE dynamic_clients.nasidentifier='%{request:NAS-Identifier}' AND realms.name='%{control:Rd-Realm}'}" == 0){
                    update reply {
                        Reply-Message := "User %{request:User-Name} belongs to realm %{control:Rd-Realm} which cannot connect to %{request:NAS-Identifier}"
                    }
                    reject
                }
            }
        }
    }
}



	RADIUSdesk_user_ssid_check {
		#__We check if the user is flagged to only connect through certain SSIDs (Rd-Ssid-Check == 1)_
		#__If so we try to find the SSID and see if this ssid is allowed for the specific user________

		#If it is present....
		if(&control:Rd-Ssid-Check){
			#If it is == 1
			if(&control:Rd-Ssid-Check == 1){
				RADIUSdesk_rewrite_called_station_id
				if(updated){
					if("%{sql:SELECT COUNT(*) FROM user_ssids WHERE username= '%{request:User-Name}' AND ssidname= '%{control:Rd-Ssid-Value}'}" > 0){
                		ok
        			}
        			else {
						update reply {
				            Reply-Message := "User %{request:User-Name} has not permission to connect through SSID: %{control:Rd-Ssid-Value}"
				        }
                		reject
        			}
				}
				else {
					update reply {
			            Reply-Message := "No SSID available to evaluate SSID restriction"
			        }
            		reject
				}
			}
		}
	}

RADIUSdesk_user_check {

    sql
    #If the sql data sourced fine; we can do tests for the presence of the following special attributes
    if(ok){
    
        #Test to see if the account for this username is active
        if((&control:Rd-Account-Disabled)&&(&control:Rd-Account-Disabled == 1)){
    	    update reply {
                Reply-Message := "User %{request:User-Name} account disabled"
            }
            reject
        }

	# New multi-state logic
if (&control:Rd-Admin-State) {
    switch "%{tolower:%{control:Rd-Admin-State}}" {
        case active {
            # allow auth to proceed
        }
        case suspended {
            update reply {
                Reply-Message := "User %{request:User-Name} account suspended"
            }
            reject
        }
        case terminated {
            update reply {
                Reply-Message := "User %{request:User-Name} account terminated"
            }
            reject
        }
        case {
            # unknown value -> reject (or treat as active if you prefer)
            update reply {
                Reply-Message := "User %{request:User-Name} invalid admin state: %{control:Rd-Admin-State}"
            }
            reject
        }
    }
} else {
    # If state is missing, treat as active (or rejectâ€”your call)
    # noop
}


        #Check if this user has an activation time
        if(&control:Rd-Account-Activation-Time){
            pl_check_activation
        }

        #Set the realm if Rd-Realm is present
        if(&control:Rd-Realm){
    	    update request {
                Realm := "%{control:Rd-Realm}"
            }
        }                       	

        #If the account type is different that the default 'sql' set the Auth-Type accordingly
        if((&control:Rd-Auth-Type)&&(&control:Rd-Auth-Type != 'sql')){
            update control {
                Auth-Type := "%{control:Rd-Auth-Type}"
            }
        }

        #Check if there are any data counters defined for this user
        RADIUSdesk_data_counter

        #Check if there are any time counters defined for this user
        RADIUSdesk_time_counter

        #Check if it is a voucher with Rd-Voucher and if it is still valid
        RADIUSdesk_voucher_check

        #Check if this realm is allowed to connect to this device
        #Depending if it is a dynamic client or normal one we do an appropriate check

        if(&control:Rd-Dynamic-Client){
            if(&control:Rd-Dynamic-Client == 1){
                RADIUSdesk_realm_dynamic_client_check
            }
            else{
                RADIUSdesk_realm_nas_check
            }
        }

		#Check if there are SSID restrictions declared
		RADIUSdesk_user_ssid_check
		
		#__ FUP Dec 2022 __
		if(&control:Rd-Fup-Comp-Count){
		    if(&control:Rd-Fup-Comp-Count >= 0){
                pl_fup
            }		
		}
		
    }
}

RADIUSdesk_main {

    # Check if MAC username and set the MAC username to the convention AA-BB-CC-DD-12...
    if(&request:User-Name =~ /^([0-9a-f]{2})[-:]+([0-9a-f]{2})[-:]+([0-9a-f]{2})[-:]+([0-9a-f]{2})[-:]+([0-9a-f]{2})[-:]+([0-9a-f]{2})$/i){
        update request {
            User-Name := "%{1}-%{2}-%{3}-%{4}-%{5}-%{6}"
        }
	}

    #If the user is not present we will reject the request
    if("%{sql:SELECT count(username) FROM radcheck WHERE radcheck.username='%{request:User-Name}'}" == 0){    
        RADIUSdesk_ppsk_defaults
        if(updated){
            #We are done with our business. The MAC was not found so we return the default VLAN and PSK
            return   
        }else{
            update reply {
                Reply-Message := "User %{request:User-Name} not registered"
            }
            reject
        }
    }
    
    #Set the timezone
    RADIUSdesk_set_timezone


    #See if the device is perhaps declared (only if Calling-Station-Id is in request)
    if(&request:Calling-Station-Id){
        if("%{sql:SELECT count(username) FROM radcheck WHERE radcheck.username='%{request:Calling-Station-Id}'}" != 0){
            RADIUSdesk_device_check
 
        }   #Are we allowing the user to connect with undeclared MAC's?
        elsif("%{sql:SELECT count(radcheck.username) FROM radcheck WHERE radcheck.username='%{request:User-Name}' and attribute='Rd-Mac-Check' and value=1}" != 0){
            update reply {
                Reply-Message := "User %{request:User-Name} are not allowed to connect with a device containing MAC %{request:Calling-Station-Id}"
            }
            reject
        }
    }

     #Check if device; and who is the owner and if the owner has some restrictions
    update control {
        Rd-Tmp-Owner := "%{sql:SELECT IFNULL((SELECT value FROM radcheck WHERE radcheck.username='%{request:User-Name}' and attribute='Rd-Device-Owner'),'rd_not_found')}"
    }

    if(&control:Rd-Tmp-Owner != 'rd_not_found'){ 
        RADIUSdesk_device_owner_check
    }
    else {
        RADIUSdesk_user_check  
    }
}

RADIUSdesk_session_timeout {

    if(&reply:Session-Timeout){
        #Check if Rd-Avail-Time AND Rd-Voucher-Timeout is present. 
        #Find the smallest of them and compare it with reply:Session-Timeout
        if((&control:Rd-Avail-Time)&&(&control:Rd-Voucher-Timeout)){
            if(&control:Rd-Avail-Time < &control:Rd-Voucher-Timeout ){
                if( &reply:Session-Timeout  >  &control:Rd-Avail-Time){
                    update reply {
                        Session-Timeout := "%{control:Rd-Avail-Time}"
                    }
                }     
            }
            else {
                if( &reply:Session-Timeout  >  &control:Rd-Voucher-Timeout){
                    update reply {
                        Session-Timeout := "%{control:Rd-Voucher-Timeout}"
                    }
                }
            }
        }
        elsif(&control:Rd-Avail-Time){
            if( &reply:Session-Timeout  >  &control:Rd-Avail-Time){
                update reply {
                    Session-Timeout := "%{control:Rd-Avail-Time}"
                }
            } 
        }
        elsif(&control:Rd-Voucher-Timeout){
            if( &reply:Session-Timeout  >  &control:Rd-Voucher-Timeout){
                update reply {
                    Session-Timeout := "%{control:Rd-Voucher-Timeout}"
                }
            }
        }
    }
    else {
        #Check if Rd-Avail-Time AND Rd-Voucher-Timeout is present. 
        #Find the smallest of them and set that to Session-Timeout reply attribute
        if((&control:Rd-Avail-Time)&&(&control:Rd-Voucher-Timeout)){
            if(&control:Rd-Avail-Time < &control:Rd-Voucher-Timeout){
                update reply {
                    Session-Timeout := "%{control:Rd-Avail-Time}"
                } 
            }
            else {
                update reply {
                    Session-Timeout := "%{control:Rd-Voucher-Timeout}"
                }
            }
        }
        elsif(&control:Rd-Avail-Time){
            update reply {
                Session-Timeout := "%{control:Rd-Avail-Time}"
            }
        }
        elsif(&control:Rd-Voucher-Timeout){
            update reply {
                Session-Timeout := "%{control:Rd-Voucher-Timeout}"
            }
        }
    }
}

#Add-On May 2022
RADIUSdesk_set_timezone {
    if(&request:NAS-Identifier){
        #Check wether the client is there and active
        update control {
            #If we do not find an entry we return 2
            Rd-Client-Timezone := "%{sql:SELECT IFNULL((SELECT tz.name FROM dynamic_clients c LEFT JOIN timezones tz ON tz.id = c.timezone where c.nasidentifier='%{request:NAS-Identifier}'),'timezone_not_found')}"            
        }
    }
    else {
        update control {
            #If we do not find an entry we return 2
            Rd-Client-Timezone := "%{sql:SELECT IFNULL((SELECT tz.name FROM user_settings us LEFT JOIN timezones tz ON tz.id = us.value where us.name='timezone' AND us.user_id=-1 LIMIT 1),'timezone_not_found')}"          
        }  
    }
}

RADIUSdesk_logintime {
    pl_logintime
}

#Add-On July 2022
RADIUSdesk_adv {

    #Typically it will be time based or data based but not a combo of both
    #Data based
    if(&control:Rd-Adv-Data){   
        pl_rd_adv
        update control {
            Rd-Adv-Day-Sessions := "%{sql:SELECT IFNULL(count(radacctid), 0) \
                FROM radacct_history WHERE username='%{request:User-Name}' AND callingstationid='%{request:Calling-Station-Id}' \
                AND UNIX_TIMESTAMP(acctstarttime)  > '%{control:Rd-Adv-Day-Start}'}"
                
            Rd-Adv-Month-Sessions := "%{sql:SELECT IFNULL(count(radacctid), 0) \
                FROM radacct_history WHERE username='%{request:User-Name}' AND callingstationid='%{request:Calling-Station-Id}' \
                AND UNIX_TIMESTAMP(acctstarttime)  > '%{control:Rd-Adv-Month-Start}'}"                               
        }
        
        if(&control:Rd-Adv-Day-Sessions >= &control:Rd-Adv-Data-Per-Day){      
            update reply {
                Reply-Message := "Max Daily Sessions Reached"
            }
            reject
               
        }else{
            update reply {
                 Mikrotik-Total-Limit := "%{control:Rd-Adv-Data}"
                 ChilliSpot-Max-Total-Octets := "%{control:Rd-Adv-Data}"
            }
            ok
        }
        
        if(&control:Rd-Adv-Month-Sessions >= &control:Rd-Adv-Data-Per-Month){
            update reply {
                Reply-Message := "Max Monthly Sessions Reached"
            }
            reject
               
        }else{
            update reply {
                 Mikrotik-Total-Limit := "%{control:Rd-Adv-Data}"
                 ChilliSpot-Max-Total-Octets := "%{control:Rd-Adv-Data}"
            }
            ok     
        }    
    }
  
    #Time based
    if(&control:Rd-Adv-Time){   
        pl_rd_adv
        update control {
            Rd-Adv-Day-Sessions := "%{sql:SELECT IFNULL(count(radacctid), 0) \
                FROM radacct_history WHERE username='%{request:User-Name}' AND callingstationid='%{request:Calling-Station-Id}' \
                AND UNIX_TIMESTAMP(acctstarttime)  > '%{control:Rd-Adv-Day-Start}'}"
                
            Rd-Adv-Month-Sessions := "%{sql:SELECT IFNULL(count(radacctid), 0) \
                FROM radacct_history WHERE username='%{request:User-Name}' AND callingstationid='%{request:Calling-Station-Id}' \
                AND UNIX_TIMESTAMP(acctstarttime)  > '%{control:Rd-Adv-Month-Start}'}"                               
        }
        
        if(&control:Rd-Adv-Day-Sessions >= &control:Rd-Adv-Time-Per-Day){      
            update reply {
                Reply-Message := "Max Daily Sessions Reached"
            }
            reject
               
        }else{
            update reply {
                 Session-Timeout := "%{control:Rd-Adv-Time}"
            }
            ok
        }
        
        if(&control:Rd-Adv-Month-Sessions >= &control:Rd-Adv-Time-Per-Month){
            update reply {
                Reply-Message := "Max Monthly Sessions Reached"
            }
            reject
               
        }else{
            update reply {
                 Session-Timeout := "%{control:Rd-Adv-Time}"
            }
            ok     
        }    
    }    
}



RADIUSdesk_post_auth {
    #This will record authentication attempts on any unknown user successfully authenticating
    
    #EAP-Message request does not contain the Realm; source it first
    if(EAP-Message){
        update control {
            Rd-Realm = "%{sql:SELECT IFNULL((SELECT value FROM radcheck WHERE radcheck.username='%{request:User-Name}' and attribute='Rd-Realm'),'rd_not_found')}"
        }

        if(&control:Rd-Realm != 'rd_not_found'){
    	    update request {
                Realm := "%{control:Rd-Realm}"
            }
        }   
    }

   sql
}

RADIUSdesk_last_accept {
    #We do this regardless - if there's a match it will update no need to first check if there is a match! 
    if(&request:NAS-Identifier){   
        "%{sql:UPDATE `permanent_users` SET last_accept_time=now(),last_contact=now(),last_accept_nas='%{request:NAS-Identifier}' where username='%{User-Name}'}"
        "%{sql:UPDATE `devices` SET last_accept_time=now(),last_contact=now(),last_accept_nas='%{request:NAS-Identifier}' where name='%{Calling-Station-Id}'}"
        "%{sql:UPDATE `vouchers` SET last_accept_time=now(),last_contact=now(),last_accept_nas='%{request:NAS-Identifier}' where name='%{User-Name}'}"
    }
}

RADIUSdesk_last_contact {
    #We do this regardless - if there's a match it will update no need to first check if there is a match!
    if(&request:NAS-Identifier){ 
        "%{sql:UPDATE `permanent_users` SET last_contact=now() where username='%{User-Name}'}"
        "%{sql:UPDATE `devices` SET last_contact=now() where name='%{Calling-Station-Id}'}"
        "%{sql:UPDATE `vouchers` SET last_contact=now() where name='%{User-Name}'}"
    }
}

RADIUSdesk_last_reject {
    #We do this regardless!
    #Check if it is an EAP request; if PEAP the error message will not be set.
    # http://freeradius.1045715.n5.nabble.com/Sending-Reply-Message-in-Access-Reject-PEAP-MSCHAPv2-td4421770.html
    if(EAP-Message){
        if(!&reply:Reply-Message){
            update reply {
                Reply-Message := "Most likely PEAP failure. Run in debug"
            }
        }
    }

    #We do this regardless - if there's a match it will update no need to first check if there is a match!
    if(&request:NAS-Identifier){
        "%{sql:UPDATE `permanent_users` SET last_reject_time=now(),last_reject_nas='%{request:NAS-Identifier}',last_reject_message='%{%{reply:Reply-Message}:-N/A}' where username='%{User-Name}'}"
        "%{sql:UPDATE `devices` SET last_reject_time=now(),last_reject_nas='%{request:NAS-Identifier}',last_reject_message='%{%{reply:Reply-Message}:-N/A}' where name='%{Calling-Station-Id}'}"
        "%{sql:UPDATE `vouchers` SET last_reject_time=now(),last_reject_nas='%{request:NAS-Identifier}',last_reject_message='%{%{reply:Reply-Message}:-N/A}' where name='%{User-Name}'}"
    }
    
}

RADIUSdesk_set_acct_realm {

    #Check if there is a realm defiend for this user and update if so
 if(&request:User-Name){
            update control {
                    Rd-Realm := "%{sql:SELECT IFNULL((SELECT value FROM radcheck WHERE radcheck.username='%{request:User-Name}' and attribute='Rd-Realm'),'rd_not_found')}"
            }
    }

    if(&control:Rd-Realm != 'rd_not_found'){ 
        update request {
            Realm := "%{control:Rd-Realm}"
        }
    }
}

RADIUSdesk_async_acct {
    #Requires a User-Name in the request and a table called new_accountings with a username column
    if((&request:User-Name)&&(&request:Calling-Station-Id)){
        "%{sql:INSERT IGNORE INTO new_accountings SET new_accountings.username='%{request:User-Name}',new_accountings.mac='%{request:Calling-Station-Id}'}"
    }
}

RADIUSdesk_auto_devices_check {
    #Requires a User-Name in the request and a table called new_accountings with a username column
    if((&request:User-Name)&&(&request:Calling-Station-Id)){
        if((&control:Rd-Auto-Mac)&&(&control:Rd-Auto-Mac == 1)){
            "%{sql:INSERT IGNORE INTO auto_devices SET auto_devices.username='%{request:User-Name}', auto_devices.mac='%{request:Calling-Station-Id}'}"
        }
    }
}


RADIUSdesk_preacct {

    #RADIUSdesk -> Used to normalise the callingstation id to format aa-bb-cc-dd-ee.. (lowercase with dash)
    RADIUSdesk_rewrite_calling_station_id

    #See if we it is perhaps a device and if we then need to change to the username
    if(&request:User-Name =~ /^([0-9a-f]{2})[-:]+([0-9a-f]{2})[-:]+([0-9a-f]{2})[-:]+([0-9a-f]{2})[-:]+([0-9a-f]{2})[-:]+([0-9a-f]{2})$/i){

        update control {
            Rd-Device-Owner = "%{sql:SELECT IFNULL((SELECT value FROM radcheck WHERE radcheck.username='%{request:Calling-Station-Id}' and attribute='Rd-Device-Owner'),'rd_not_found')}"
        }

        if(&control:Rd-Device-Owner != 'rd_not_found'){
            update request {
                User-Name := "%{control:Rd-Device-Owner}"
            }
        }

        #Add the posibility to attach devices to Vouchers
        update control {
            Rd-Voucher-Device-Owner = "%{sql:SELECT IFNULL((SELECT value FROM radcheck WHERE radcheck.username='%{request:Calling-Station-Id}' and attribute='Rd-Voucher-Device-Owner'),'rd_not_found')}"
        }

        if(&control:Rd-Voucher-Device-Owner != 'rd_not_found'){
            update request {
                User-Name := "%{control:Rd-Voucher-Device-Owner}"
            }
        }
    }

    RADIUSdesk_set_acct_realm
    RADIUSdesk_async_acct
}

RADIUSdesk_acct {
	sql
}

#____ END RADIUSdesk policies __________
